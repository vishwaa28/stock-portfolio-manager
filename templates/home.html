{% extends "base.html" %}
{% block title %}Home - Portfolio Manager{% endblock %}

{% block body %}
    <!-- 🔁 Continuous Ticker -->
<div class="ticker-container">
    <div class="ticker-track">
        {% for _ in range(2) %}  <!-- Duplicate items for smooth loop -->
            {% for stock in ticker_data %}
            <div class="ticker-item {{ 'up' if stock.change > 0 else 'down' if stock.change < 0 else 'neutral' }}">
                <span class="symbol">{{ stock.symbol }}</span>
                <span class="price stock-price" data-symbol="{{ stock.symbol }}">${{ "%.2f"|format(stock.price) }}</span>
            </div>
            {% endfor %}
        {% endfor %}
    </div>
</div>

<div class="container-fluid py-4 px-1">
    <div class="row gx-2">
        <!-- 📊 Left Side: Full Stock Table -->
        <div class="col-12 col-lg-7">
            <div class="card shadow-sm h-100" style="min-height: 78vh;">
                <div class="card-body d-flex flex-column">
                    <h5 class="mb-3 fw-semibold text-dark">Live Market Feed</h5>
                    <div class="table-responsive flex-grow-1" style="overflow-y: auto;">
                        <table class="table table-hover align-middle mb-0" id="liveMarketFeedTable">
                            <thead style="background:#fff; color:#222;">
                                <tr>
                                    <th>Symbol</th>
                                    <th>Name</th>
                                    <th>Price</th>
                                    <th>Change</th>
                                    <th>Sector</th>
                                    <th>Market Cap</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- JS dynamically populates -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 📈📃 Right Side: Chart + News -->
        <div class="col-12 col-lg-5 d-flex flex-column">
            <!-- Stock Chart -->
            <div class="card shadow-sm mb-3">
                <div class="card-body">
                    <h5 class="mb-3 fw-semibold text-dark">Stock Trend</h5>
                    <canvas id="stockChart" height="180"></canvas>
                </div>
            </div>

            <!-- News Feed -->
            <div class="card shadow-sm flex-grow-1 d-flex flex-column" style="overflow: hidden;">
                <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0 fw-semibold text-dark">Latest Market News</h5>
                        <select id="sectorFilter" class="form-select form-select-sm w-auto" style="min-width:160px;">
                            <option value="all">All Sectors</option>
                        </select>
                    </div>
                    <div id="newsGrid" class="flex-grow-1" style="overflow-y: auto;">
                        {% for news in news_list[:10] %}
                        <div class="py-3 border-bottom news-item" data-sector="general">
                            <h6 class="mb-1 fw-medium text-dark">{{ news.title }}</h6>
                            <div class="text-muted small mb-1">
                                <i class="fas fa-building"></i> {{ news.source }} &bull;
                                <i class="fas fa-clock"></i> {{ news.published }}
                            </div>
                            <a href="{{ news.url }}" target="_blank" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-external-link-alt"></i> Read More
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let chartInstance;
let selectedRow = null;
let stockSectors = new Set();

function updateChart(symbol) {
    fetch(`/api/stock_history/${symbol}`)
        .then(res => res.json())
        .then(data => {
            const labels = data.map(item => item.date);
            const prices = data.map(item => item.price);
            if (chartInstance) chartInstance.destroy();
            const ctx = document.getElementById('stockChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${symbol} Price`,
                        data: prices,
                        borderColor: '#444',
                        backgroundColor: 'rgba(100,100,100,0.07)',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { title: { display: true, text: 'Date' }},
                        y: { title: { display: true, text: 'Price (USD)' }}
                    }
                }
            });
        });
}

document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/top_stocks')
        .then(res => res.json())
        .then(stocks => {
            const tbody = document.querySelector('#liveMarketFeedTable tbody');
            tbody.innerHTML = '';
            stockSectors.clear();
            stocks.forEach((stock, idx) => {
                stockSectors.add(stock.sector);
                const tr = document.createElement('tr');
                tr.style.cursor = 'pointer';
                tr.onclick = function() {
                    if (selectedRow) selectedRow.classList.remove('table-active');
                    tr.classList.add('table-active');
                    selectedRow = tr;
                    updateChart(stock.symbol);
                };
                if (idx === 0) {
                    setTimeout(() => { tr.click(); }, 100); // Auto-select first
                }
                tr.innerHTML = `
                    <td><strong>${stock.symbol}</strong></td>
                    <td><small class="text-muted">${stock.name}</small></td>
                    <td class="stock-price" data-symbol="${stock.symbol}">$${stock.price !== null ? stock.price.toFixed(2) : 'N/A'}</td>
                    <td class="${stock.change > 0 ? 'text-success' : stock.change < 0 ? 'text-danger' : ''}">${stock.change !== null ? stock.change.toFixed(2) : 'N/A'}</td>
                    <td>${stock.sector}</td>
                    <td>${stock.market_cap !== null && stock.market_cap !== undefined ? stock.market_cap : 'N/A'}</td>
                `;
                tbody.appendChild(tr);
            });
            // Populate sector filter
            const sectorFilter = document.getElementById('sectorFilter');
            sectorFilter.innerHTML = '<option value="all">All Sectors</option>';
            Array.from(stockSectors).sort().forEach(sector => {
                sectorFilter.innerHTML += `<option value="${sector}">${sector}</option>`;
            });
        });

    // Sector filter for news
    document.getElementById('sectorFilter').addEventListener('change', function() {
        const selected = this.value.toLowerCase();
        const newsItems = document.querySelectorAll('#newsGrid .news-item');
        newsItems.forEach(item => {
            const sector = (item.getAttribute('data-sector') || '').toLowerCase();
            if (selected === 'all' || sector === selected || sector === 'general') {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    });
});
</script>

{% endblock %}

