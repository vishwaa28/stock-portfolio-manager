{% extends "base.html" %}
{% block title %}Dashboard - Portfolio Manager{% endblock %}

{% block body %}
<div class="fade-in-up">
    <!-- Dashboard Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-6 mb-0">
                        <i class="fas fa-tachometer-alt text-primary"></i>
                        Portfolio Dashboard
                    </h1>
                    <p class="text-muted">Monitor your investments and market alerts</p>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <div class="position-relative dropdown">
                        <i class="fas fa-bell fs-4 text-muted cursor-pointer" id="notificationIcon" data-bs-toggle="dropdown" aria-expanded="false"></i>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="alertCount" style="display: none;">
                            0
                        </span>
                        <ul class="dropdown-menu dropdown-menu-end" id="alertDropdown" style="width: 400px; max-height: 500px; overflow-y: auto;">
                            <li><h6 class="dropdown-header">Portfolio Alerts & Insights</h6></li>
                            <li><hr class="dropdown-divider"></li>
                            <li id="alertList">
                                <span class="dropdown-item-text text-muted">No active alerts</span>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li id="portfolioSummary">
                                <div class="dropdown-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">Portfolio Summary</small>
                                        <small class="text-muted" id="portfolioStats">Loading...</small>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addStockModal">
                        <i class="fas fa-plus"></i> Add Stock
                    </button>
                    <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="btn btn-outline-warning" onclick="testNotification()">
                        <i class="fas fa-bell"></i> Test Alert
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Portfolio Summary Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3 col-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body d-flex align-items-center gap-3">
                    <div class="icon-box bg-light text-dark"><i class="fas fa-wallet"></i></div>
                    <div>
                        <div class="fw-bold fs-4">${{ "%.2f"|format(total_value) }}</div>
                        <div class="text-muted small">Total Value</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body d-flex align-items-center gap-3">
                    <div class="icon-box bg-light text-dark"><i class="fas fa-arrow-up"></i></div>
                    <div>
                        <div class="fw-bold fs-4 text-success">{{ table|selectattr("sentiment_class", "equalto", "positive")|list|length }}</div>
                        <div class="text-muted small">Positive Sentiment</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body d-flex align-items-center gap-3">
                    <div class="icon-box bg-light text-dark"><i class="fas fa-chart-line"></i></div>
                    <div>
                        <div class="fw-bold fs-4 text-primary">{{ table|length }}</div>
                        <div class="text-muted small">Stocks Tracked</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body d-flex align-items-center gap-3">
                    <div class="icon-box bg-light text-dark"><i class="fas fa-exclamation-triangle"></i></div>
                    <div>
                        <div class="fw-bold fs-4 text-warning" id="totalAlerts">{{ (table|selectattr("alerts")|list|length) }}</div>
                        <div class="text-muted small">Active Alerts</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if table %}
    <div class="row g-4">
        <!-- Left Side: Portfolio Stocks Table -->
        <div class="col-12 col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="mb-3 fw-semibold text-dark">Portfolio Holdings</h5>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead style="background:#f8f9fa;">
                                <tr>
                                    <th>Symbol</th>
                                    <th>Name</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Total Value</th>
                                    <th>Day's Gain %</th>
                                    <th>Overall Gain %</th>
                                    <th>Change</th>
                                    <th>Sentiment</th>
                                    <th>Score</th>
                                    <th>Alerts</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in table %}
                                <tr class="stock-row" data-symbol="{{ row.symbol }}" style="cursor: pointer;">
                                    <td><strong>{{ row.symbol }}</strong></td>
                                    <td><small class="text-muted">{{ row.name|default('N/A') }}</small></td>
                                    <td class="stock-price" data-symbol="{{ row.symbol }}">${{ "%.2f"|format(row.price) }}</td>
                                    <td>{{ row.quantity }}</td>
                                    <td>${{ "%.2f"|format(row.total_value) }}</td>
                                    <td>{% if row.days_gain_pct is not none %}{{ "%.2f"|format(row.days_gain_pct) }}%{% else %}-{% endif %}</td>
                                    <td>{% if row.overall_gain_pct is not none %}{{ "%.2f"|format(row.overall_gain_pct) }}%{% else %}-{% endif %}</td>
                                    <td class="{% if row.change > 0 %}text-success{% elif row.change < 0 %}text-danger{% endif %}">
                                        {{ "%.2f"|format(row.change|default(0)) }}
                                    </td>
                                    <td>
                                        <span class="badge sentiment-{{ row.sentiment_class }}">
                                            {{ row.sentiment_text }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge {% if row.sentiment_score > 0.7 %}bg-success{% elif row.sentiment_score < 0.3 %}bg-danger{% else %}bg-warning{% endif %}">
                                            {{ "%.1f"|format(row.sentiment_score|default(0.5)) }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if row.alerts %}
                                            <span class="badge bg-warning text-dark">{{ row.alerts|length }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Dynamic Chart Section -->
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0 fw-semibold text-dark">
                            <i class="fas fa-chart-line me-2"></i>
                            <span id="chartTitle">Select a stock to view chart</span>
                        </h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <input type="radio" class="btn-check" name="chartPeriod" id="period1m" value="1M" checked>
                            <label class="btn btn-outline-primary" for="period1m">1M</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="period3m" value="3M">
                            <label class="btn btn-outline-primary" for="period3m">3M</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="period6m" value="6M">
                            <label class="btn btn-outline-primary" for="period6m">6M</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="period1y" value="1Y">
                            <label class="btn btn-outline-primary" for="period1y">1Y</label>
                        </div>
                    </div>
                    
                    <!-- Chart Container -->
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <canvas id="portfolioChart"></canvas>
                        <div id="chartLoading" class="chart-loading" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading chart data...</p>
                        </div>
                        <div id="chartPlaceholder" class="chart-placeholder">
                            <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Click on any stock in the table above to view its price chart</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Side: Portfolio News - Full Height -->
        <div class="col-12 col-lg-4">
            <div class="card shadow-sm" style="height: fit-content; max-height: calc(100vh - 200px);">
                <div class="card-body d-flex flex-column h-100 p-0">
                    <div class="p-3 border-bottom">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0 fw-semibold text-dark">
                                <span id="newsTitle">Portfolio News</span>
                                <span id="selectedStockInfo" class="text-primary ms-2" style="display: none;"></span>
                            </h5>
                            <div class="d-flex align-items-center gap-2">
                                <button id="clearStockFilter" class="btn btn-sm btn-outline-secondary" style="display:none;">
                                    <i class="fas fa-times"></i> Show All
                                </button>
                                <select id="newsSectorFilter" class="form-select form-select-sm w-auto" style="min-width:160px;">
                                    <option value="all">All Sectors</option>
                                </select>
                                <button id="clearFilter" class="btn btn-sm btn-outline-secondary" style="display:none;">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                        </div>
                        <div id="filterInfo" class="filter-info mb-2"></div>
                    </div>
                    <div id="portfolioNews" class="flex-grow-1" style="overflow-y: auto; max-height: calc(100vh - 350px);">
                        {% for row in table %}
                            {% for article in row.news[:3] %}
                            <div class="py-3 px-3 border-bottom news-card" data-sentiment="{{ article.sentiment }}" data-score="{{ article.sentiment_score|default(0.5) }}" data-sector="{{ article.sector|default('Unknown') }}" data-symbol="{{ article.symbol|default(row.symbol) }}">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-1 fw-medium text-dark">{{ article.title[:70] }}{% if article.title|length > 70 %}...{% endif %}</h6>
                                    <span class="badge {% if article.sentiment == 'negative' and article.sentiment_score|default(0.5) > 0.7 %}bg-danger{% elif article.sentiment == 'positive' %}bg-success{% else %}bg-secondary{% endif %}">
                                        {{ article.sentiment|title }}
                                    </span>
                                </div>
                                <div class="mb-2">
                                    <span class="badge bg-info me-1">{{ article.symbol|default(row.symbol) }}</span>
                                    <span class="badge bg-secondary">{{ article.sector|default('Unknown') }}</span>
                                </div>
                                <p class="text-muted small mb-2">
                                    <i class="fas fa-newspaper me-1"></i>{{ article.source|default('Unknown') }} 
                                    <i class="fas fa-calendar ms-2 me-1"></i>{{ article.published|default('N/A') }}
                                </p>
                                {% if article.description %}
                                <p class="text-muted small mb-2">{{ article.description[:100] }}{% if article.description|length > 100 %}...{% endif %}</p>
                                {% endif %}
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="fas fa-chart-line me-1"></i>Score: {{ "%.2f"|format(article.sentiment_score|default(0.5)) }}
                                    </small>
                                    <a href="{{ article.url|default('#') }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-external-link-alt"></i> Read
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        {% endfor %}
                        {% if not table|selectattr('news')|list %}
                        <div class="text-center py-4">
                            <i class="fas fa-newspaper fa-2x text-muted mb-2"></i>
                            <p class="text-muted">No news available for your portfolio</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Empty State -->
    <div class="text-center py-5">
        <div class="card">
            <div class="card-body py-5">
                <i class="fas fa-chart-line fa-4x text-muted mb-3"></i>
                <h3 class="text-muted">Your portfolio is empty</h3>
                <p class="text-muted mb-4">Start by adding some stocks to track your investments</p>
                <a href="{{ url_for('add_stock') }}" class="btn btn-primary btn-lg">
                    <i class="fas fa-plus"></i> Add Your First Stock
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Add Stock Modal -->
<div class="modal fade" id="addStockModal" tabindex="-1" aria-labelledby="addStockModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title" id="addStockModalLabel">
                    <i class="fas fa-plus-circle me-2"></i>Add Stock to Portfolio
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addStockForm">
                    <div class="mb-3">
                        <label for="stockSymbol" class="form-label fw-semibold">
                            <i class="fas fa-chart-line me-2"></i>Stock Symbol
                        </label>
                        <input type="text" class="form-control" id="stockSymbol" name="symbol" 
                               placeholder="e.g., AAPL, GOOGL, TSLA" required>
                        <div class="form-text">Enter the stock symbol in uppercase letters</div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="stockQuantity" class="form-label fw-semibold">
                                    <i class="fas fa-layer-group me-2"></i>Quantity
                                </label>
                                <input type="number" class="form-control" id="stockQuantity" name="quantity" 
                                       placeholder="e.g., 10" value="1" min="1" required>
                                <div class="form-text">Number of shares</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="purchasePrice" class="form-label fw-semibold">
                                    <i class="fas fa-dollar-sign me-2"></i>Purchase Price
                                </label>
                                <input type="number" class="form-control" id="purchasePrice" name="purchase_price" 
                                       placeholder="e.g., 150.00" step="0.01" min="0">
                                <div class="form-text">Average price per share (optional)</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Popular Stocks Quick Add -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-star text-warning me-2"></i>Quick Add Popular Stocks
                        </label>
                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="setStockSymbol('AAPL')">AAPL</button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="setStockSymbol('GOOGL')">GOOGL</button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="setStockSymbol('MSFT')">MSFT</button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="setStockSymbol('TSLA')">TSLA</button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="setStockSymbol('AMZN')">AMZN</button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="setStockSymbol('META')">META</button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="setStockSymbol('NVDA')">NVDA</button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="setStockSymbol('NFLX')">NFLX</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-success" onclick="addStockToPortfolio()">
                    <i class="fas fa-plus me-2"></i>Add to Portfolio
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Professional Dashboard Styling */
:root {
    --primary-color: #667eea;
    --secondary-color: #764ba2;
    --success-color: #28a745;
    --danger-color: #dc3545;
    --warning-color: #ffc107;
    --info-color: #17a2b8;
    --light-color: #f8f9fa;
    --dark-color: #343a40;
    --border-radius: 12px;
    --box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    --box-shadow-hover: 0 8px 30px rgba(0,0,0,0.12);
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Sentiment Badges */
.sentiment-positive { 
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    color: #155724; 
    border: 1px solid #c3e6cb;
    font-weight: 600;
}

.sentiment-negative { 
    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    color: #721c24; 
    border: 1px solid #f5c6cb;
    font-weight: 600;
}

.sentiment-neutral { 
    background: linear-gradient(135deg, #e2e3e5 0%, #d6d8db 100%);
    color: #383d41; 
    border: 1px solid #d6d8db;
    font-weight: 600;
}

/* Icon Boxes */
.icon-box { 
    width: 50px; 
    height: 50px; 
    border-radius: var(--border-radius); 
    display: flex; 
    align-items: center; 
    justify-content: center;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px solid #dee2e6;
}

/* Cursor Pointer */
.cursor-pointer { 
    cursor: pointer; 
    transition: var(--transition);
}

.cursor-pointer:hover {
    transform: scale(1.1);
}

/* News Cards */
.news-card { 
    transition: var(--transition); 
    border: 1px solid #e9ecef;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: var(--border-radius);
    position: relative;
    overflow: hidden;
}

.news-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    opacity: 0;
    transition: var(--transition);
}

.news-card:hover { 
    transform: translateY(-3px); 
    box-shadow: var(--box-shadow-hover);
    border-color: var(--primary-color);
}

.news-card:hover::before {
    opacity: 1;
}

/* Dropdown Styling */
.dropdown-menu { 
    border: none; 
    box-shadow: var(--box-shadow-hover);
    border-radius: var(--border-radius);
    border: 1px solid #e9ecef;
}

.dropdown-header {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    font-weight: 600;
    border-radius: var(--border-radius) var(--border-radius) 0 0;
    margin: -0.5rem -0.5rem 0.5rem -0.5rem;
    padding: 0.75rem 1rem;
}

/* Alert Items */
.alert-item { 
    border-left: 4px solid var(--danger-color); 
    padding: 12px 15px;
    margin: 8px 0;
    background: linear-gradient(135deg, #fff5f5 0%, #ffe6e6 100%);
    border-radius: 8px;
    border: 1px solid #f5c6cb;
    transition: var(--transition);
}

.alert-item:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 15px rgba(220, 53, 69, 0.2);
}

/* Enhanced Alert Styling */
.alert-item[data-severity="high"] {
    border-left-color: #dc3545;
    background: linear-gradient(135deg, #fff5f5 0%, #ffe6e6 100%);
}

.alert-item[data-severity="medium"] {
    border-left-color: #ffc107;
    background: linear-gradient(135deg, #fffbf0 0%, #fff3cd 100%);
}

.alert-item[data-severity="low"] {
    border-left-color: #17a2b8;
    background: linear-gradient(135deg, #f0f9ff 0%, #e6f3ff 100%);
}

/* Category Headers */
.dropdown-item-text.fw-semibold.text-primary {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    border-radius: 6px;
    padding: 8px 12px;
    margin: 8px 0;
    border-left: 3px solid var(--primary-color);
}

/* Portfolio Summary Styling */
#portfolioSummary .dropdown-item {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 8px;
    margin: 8px 0;
    border: 1px solid #dee2e6;
}

#portfolioSummary .row {
    margin: 0;
}

#portfolioSummary .col-4 {
    padding: 8px 4px;
}

#portfolioSummary .fw-bold {
    color: var(--primary-color);
    font-size: 1.1rem;
}

/* Notification Icon Animation */
@keyframes notificationPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

#notificationIcon.has-alerts {
    animation: notificationPulse 2s infinite;
    color: var(--warning-color) !important;
}

/* Alert Badge Styling */
#alertCount {
    font-size: 0.7rem;
    font-weight: 600;
    animation: notificationPulse 2s infinite;
}

/* Empty State Styling */
.dropdown-item.text-center.py-3 {
    background: linear-gradient(135deg, #f8fff9 0%, #e8f5e8 100%);
    border-radius: 8px;
    margin: 8px 0;
    border: 1px solid #d4edda;
}

/* Performance Indicators */
.text-success .fas {
    color: #28a745;
}

.text-danger .fas {
    color: #dc3545;
}

/* Enhanced Dropdown Styling */
.dropdown-menu {
    border: none;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    border-radius: 12px;
    border: 1px solid #e9ecef;
    backdrop-filter: blur(10px);
}

.dropdown-header {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    font-weight: 600;
    border-radius: 12px 12px 0 0;
    margin: -0.5rem -0.5rem 0.5rem -0.5rem;
    padding: 1rem;
    text-align: center;
}

.dropdown-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #28a745, #20c997, #17a2b8, #ffc107, #dc3545);
    border-radius: 12px 12px 0 0;
}

/* Cards */
.card {
    border: none;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    transition: var(--transition);
    background: white;
    overflow: hidden;
}

.card:hover {
    box-shadow: var(--box-shadow-hover);
    transform: translateY(-2px);
}

/* Table Styling */
.table {
    border-radius: var(--border-radius);
    overflow: hidden;
    margin-bottom: 0;
}

.table thead th {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    border: none;
    font-weight: 600;
    padding: 15px 12px;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.table tbody tr {
    transition: var(--transition);
    border-bottom: 1px solid #f8f9fa;
}

.table tbody tr:hover {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
    transform: scale(1.01);
}

.table tbody td {
    padding: 12px;
    vertical-align: middle;
    border: none;
}

/* Badges */
.badge {
    font-weight: 600;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    letter-spacing: 0.3px;
    text-transform: uppercase;
}

/* Buttons */
.btn {
    border-radius: 25px;
    font-weight: 600;
    transition: var(--transition);
    border: none;
    padding: 8px 16px;
    font-size: 0.875rem;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.btn-outline-primary {
    border: 2px solid var(--primary-color);
    color: var(--primary-color);
}

.btn-outline-primary:hover {
    background: rgba(102, 126, 234, 0.1);
    border-color: var(--primary-color);
    color: var(--primary-color);
}

/* Notification Icon */
#notificationIcon {
    transition: var(--transition);
    padding: 8px;
    border-radius: 50%;
}

#notificationIcon:hover {
    transform: scale(1.1);
    color: var(--primary-color) !important;
    background: rgba(102, 126, 234, 0.1);
}

/* Responsive Design */
@media (max-width: 768px) {
    .table thead th {
        font-size: 0.8rem;
        padding: 10px 8px;
    }
    
    .table tbody td {
        padding: 8px;
        font-size: 0.875rem;
    }
    
    .badge {
        font-size: 0.7rem;
        padding: 4px 8px;
    }
    
    .card-body {
        padding: 1rem;
    }
}

/* Loading Animation */
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.loading {
    animation: pulse 1.5s infinite;
}

/* Scrollbar Styling */
#portfolioNews::-webkit-scrollbar {
    width: 6px;
}

#portfolioNews::-webkit-scrollbar-track {
    background: #f8f9fa;
    border-radius: 3px;
}

#portfolioNews::-webkit-scrollbar-thumb {
    background: #dee2e6;
    border-radius: 3px;
}

#portfolioNews::-webkit-scrollbar-thumb:hover {
    background: #adb5bd;
}

/* Chart Styling */
.chart-container {
    position: relative;
    background: white;
    border-radius: var(--border-radius);
    padding: 20px;
    border: 1px solid #e9ecef;
}

.chart-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    z-index: 10;
}

.chart-placeholder {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    z-index: 5;
}

/* Stock Row Hover Effects */
.stock-row {
    transition: var(--transition);
}

.stock-row:hover {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%) !important;
    transform: scale(1.01);
}

.stock-row.selected {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%) !important;
    border-left: 4px solid var(--primary-color);
}

/* Chart Period Buttons */
.btn-check:checked + .btn-outline-primary {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    border-color: var(--primary-color);
    color: white;
}

.btn-outline-primary {
    border: 2px solid var(--primary-color);
    color: var(--primary-color);
    font-weight: 600;
    transition: var(--transition);
}

.btn-outline-primary:hover {
    background: rgba(102, 126, 234, 0.1);
    border-color: var(--primary-color);
    color: var(--primary-color);
}

/* Modal Styling */
.modal-content {
    border: none;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow-hover);
}

.modal-header {
    border: none;
    border-radius: var(--border-radius) var(--border-radius) 0 0;
}

.modal-footer {
    border: none;
    border-radius: 0 0 var(--border-radius) var(--border-radius);
    padding: 1rem 1.5rem;
}

.bg-gradient-primary {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
}

/* Success Button Styling */
.btn-success {
    background: linear-gradient(135deg, #28a745, #20c997);
    border: none;
    color: white;
    font-weight: 600;
    transition: var(--transition);
}

.btn-success:hover {
    background: linear-gradient(135deg, #218838, #1ea085);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    color: white;
}

.card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
}

.card:hover {
    box-shadow: 0 4px 20px rgba(0,0,0,0.12);
    transform: translateY(-2px);
}

.table th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    font-weight: 600;
}

.table td {
    vertical-align: middle;
    border-color: #f8f9fa;
}

.table tbody tr:hover {
    background-color: #f8f9fa;
    transform: scale(1.01);
    transition: all 0.2s ease;
}

.sentiment-positive {
    color: #28a745;
    font-weight: 600;
}

.sentiment-negative {
    color: #dc3545;
    font-weight: 600;
}

.sentiment-neutral {
    color: #6c757d;
    font-weight: 600;
}

.price-change-positive {
    color: #28a745;
    font-weight: 600;
}

.price-change-negative {
    color: #dc3545;
    font-weight: 600;
}

.news-card {
    transition: all 0.3s ease;
    background: white;
}

.news-card:hover {
    background: #f8f9fa;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.news-card:last-child {
    border-bottom: none !important;
}

.chart-container {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    margin-top: 20px;
}

.period-btn {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    color: #6c757d;
    transition: all 0.3s ease;
}

.period-btn:hover, .period-btn.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-color: #667eea;
    color: white;
}

.notification-badge {
    position: relative;
    display: inline-block;
}

.notification-count {
    position: absolute;
    top: -8px;
    right: -8px;
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.dropdown-menu {
    border: none;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    border-radius: 12px;
    padding: 0;
    min-width: 350px;
}

.dropdown-item {
    padding: 12px 20px;
    border-bottom: 1px solid #f8f9fa;
    transition: all 0.2s ease;
}

.dropdown-item:hover {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.dropdown-item:last-child {
    border-bottom: none;
}

.alert-section {
    border-left: 4px solid #007bff;
    padding-left: 15px;
    margin-bottom: 15px;
}

.alert-section.negative {
    border-left-color: #dc3545;
}

.alert-section.positive {
    border-left-color: #28a745;
}

.alert-section.price {
    border-left-color: #ffc107;
}

.severity-high {
    color: #dc3545;
    font-weight: 600;
}

.severity-medium {
    color: #ffc107;
    font-weight: 600;
}

.severity-low {
    color: #28a745;
    font-weight: 600;
}

.portfolio-insights {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
}

.insight-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
}

.insight-item:last-child {
    margin-bottom: 0;
}

.insight-label {
    font-weight: 500;
}

.insight-value {
    font-weight: 600;
}

.modal-content {
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px 12px 0 0;
}

.quick-add-btn {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    color: #495057;
    transition: all 0.3s ease;
    margin: 2px;
}

.quick-add-btn:hover {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-color: #667eea;
    color: white;
    transform: translateY(-1px);
}

/* Sector filter styling */
#newsSectorFilter {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    background: white;
    transition: all 0.3s ease;
}

#newsSectorFilter:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.news-card.hidden {
    display: none !important;
}

.filter-info {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 8px;
}

/* Portfolio News Scrollbar Styling */
#portfolioNews {
    scrollbar-width: thin;
    scrollbar-color: #dee2e6 #f8f9fa;
}

#portfolioNews::-webkit-scrollbar {
    width: 6px;
}

#portfolioNews::-webkit-scrollbar-track {
    background: #f8f9fa;
    border-radius: 3px;
}

#portfolioNews::-webkit-scrollbar-thumb {
    background: #dee2e6;
    border-radius: 3px;
}

#portfolioNews::-webkit-scrollbar-thumb:hover {
    background: #adb5bd;
}

/* News card styling for dashboard */
.news-card {
    transition: all 0.3s ease;
    background: white;
}

.news-card:hover {
    background: #f8f9fa;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.news-card:last-child {
    border-bottom: none !important;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let chartInstance = null;
let selectedStock = null;
let currentPeriod = '1M';

document.addEventListener('DOMContentLoaded', function() {
    // Initialize sector filter for portfolio news
    initializePortfolioSectorFilter();
    
    // Set portfolio news height to match left side content
    setPortfolioNewsHeight();
    
    // Get stock rows first
    const stockRowElements = document.querySelectorAll('.stock-row');
    
    // Simple alert detection
    let allAlerts = [];
    let totalAlerts = 0;
    
    // Add a test alert to ensure the system works (remove this later)
    allAlerts.push({
        symbol: 'TEST',
        title: 'Test alert - system is working',
        severity: 'medium',
        type: 'test'
    });
    totalAlerts++;
    
    // Force test - always show at least 1 alert for testing
    if (totalAlerts === 0) {
        allAlerts.push({
            symbol: 'FORCE',
            title: 'Forced test alert - system check',
            severity: 'medium',
            type: 'test'
        });
        totalAlerts = 1;
    }
    
    // Check for negative sentiment in news
    const negativeNews = document.querySelectorAll('.news-card[data-sentiment="negative"]');
    negativeNews.forEach(news => {
        const symbol = news.dataset.symbol;
        const score = parseFloat(news.dataset.score);
        const title = news.querySelector('h6').textContent;
        
        if (score > 0.6) { // High negative sentiment
            allAlerts.push({
                symbol: symbol,
                title: `Negative news: ${title.substring(0, 50)}...`,
                severity: 'high',
                type: 'news'
            });
            totalAlerts++;
        }
    });
    
    // Check for alerts in portfolio stocks (from backend alerts array)
    stockRowElements.forEach(row => {
        const symbol = row.querySelector('td:first-child strong').textContent;
        const alertsCell = row.querySelector('td:nth-child(9)');
        
        console.log(`Checking alerts for ${symbol}:`, {
            alertsCell: alertsCell,
            alertsCellHTML: alertsCell ? alertsCell.innerHTML : 'null'
        });
        
        // Check if there are any alerts displayed in the alerts column
        if (alertsCell) {
            const alertBadge = alertsCell.querySelector('.badge');
            console.log(`Alert badge for ${symbol}:`, {
                alertBadge: alertBadge,
                badgeText: alertBadge ? alertBadge.textContent : 'null'
            });
            
            if (alertBadge && alertBadge.textContent !== '-') {
                const alertCount = parseInt(alertBadge.textContent);
                console.log(`Alert count for ${symbol}:`, alertCount);
                if (alertCount > 0) {
                    allAlerts.push({
                        symbol: symbol,
                        title: `${symbol} has ${alertCount} alert(s)`,
                        severity: 'medium',
                        type: 'portfolio'
                    });
                    totalAlerts += alertCount;
                    console.log(`Added portfolio alert for ${symbol}, total alerts now:`, totalAlerts);
                }
            }
        }
        
        // Check for negative sentiment
        const sentimentCell = row.querySelector('td:nth-child(7) .badge');
        const sentimentScoreCell = row.querySelector('td:nth-child(8) .badge');
        
        console.log(`Sentiment check for ${symbol}:`, {
            sentimentCell: sentimentCell ? sentimentCell.textContent : 'null',
            sentimentScoreCell: sentimentScoreCell ? sentimentScoreCell.textContent : 'null'
        });
        
        if (sentimentCell && sentimentScoreCell) {
            const sentiment = sentimentCell.textContent;
            const sentimentScore = parseFloat(sentimentScoreCell.textContent);
            
            if (sentiment.includes('Negative') || sentimentScore < 0.4) {
                allAlerts.push({
                    symbol: symbol,
                    title: `${symbol} showing negative sentiment`,
                    severity: sentimentScore < 0.3 ? 'high' : 'medium',
                    type: 'sentiment'
                });
                totalAlerts++;
                console.log(`Added sentiment alert for ${symbol}, total alerts now:`, totalAlerts);
            }
        }
    });
    
    // Update notification icon
    const notificationIcon = document.getElementById('notificationIcon');
    const alertCountBadge = document.getElementById('alertCount');
    const alertList = document.getElementById('alertList');
    
    console.log('DOM elements found:', {
        notificationIcon: notificationIcon,
        alertCountBadge: alertCountBadge,
        alertList: alertList
    });
    
    console.log('Alert detection results:', {
        totalAlerts: totalAlerts,
        allAlerts: allAlerts,
        negativeNewsCount: document.querySelectorAll('.news-card[data-sentiment="negative"]').length,
        stockRowsCount: stockRowElements.length
    });
    
    if (totalAlerts > 0) {
        // Show notification badge
        console.log('Attempting to show notification badge with', totalAlerts, 'alerts');
        
        if (notificationIcon) {
            notificationIcon.classList.remove('text-muted');
            notificationIcon.classList.add('text-warning', 'has-alerts');
            console.log('Updated notification icon classes');
        } else {
            console.error('Notification icon not found!');
        }
        
        if (alertCountBadge) {
            alertCountBadge.textContent = totalAlerts;
            alertCountBadge.style.display = 'block';
            console.log('Updated alert count badge');
        } else {
            console.error('Alert count badge not found!');
        }
        
        console.log('Showing alerts:', totalAlerts);
        
        // Populate alert dropdown
        if (alertList) {
            alertList.innerHTML = '';
            
            allAlerts.forEach(alert => {
                const alertItem = document.createElement('div');
                alertItem.className = 'dropdown-item alert-item';
                alertItem.setAttribute('data-severity', alert.severity);
                
                const severityIcon = alert.severity === 'high' ? 'fas fa-exclamation-circle text-danger' : 
                                   'fas fa-exclamation-triangle text-warning';
                
                alertItem.innerHTML = `
                    <div class="d-flex align-items-start">
                        <div class="flex-shrink-0 me-2">
                            <i class="${severityIcon}"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong class="text-dark">${alert.symbol}</strong>
                                    <span class="badge bg-secondary ms-1">${alert.type}</span>
                                </div>
                                <span class="badge ${alert.severity === 'high' ? 'bg-danger' : 'bg-warning'}">${alert.severity}</span>
                            </div>
                            <div class="text-dark small mt-1">${alert.title}</div>
                        </div>
                    </div>
                `;
                alertList.appendChild(alertItem);
            });
            console.log('Populated alert list with', allAlerts.length, 'alerts');
        } else {
            console.error('Alert list not found!');
        }
    } else {
        // Hide notification badge
        console.log('No alerts found, hiding notification badge');
        
        if (notificationIcon) {
            notificationIcon.classList.remove('text-warning', 'has-alerts');
            notificationIcon.classList.add('text-muted');
        }
        
        if (alertCountBadge) {
            alertCountBadge.style.display = 'none';
        }
        
        if (alertList) {
            alertList.innerHTML = `
                <div class="dropdown-item text-center py-3">
                    <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                    <p class="text-muted mb-0">No active alerts</p>
                    <small class="text-muted">Your portfolio is performing well!</small>
                </div>
            `;
        }
    }
    
    // Update portfolio summary
    const portfolioStats = document.getElementById('portfolioStats');
    const portfolioHealth = totalAlerts === 0 ? 'Good' : totalAlerts <= 3 ? 'Stable' : 'Needs Attention';
    
    portfolioStats.innerHTML = `
        <span class="badge ${portfolioHealth === 'Good' ? 'bg-success' : portfolioHealth === 'Needs Attention' ? 'bg-warning' : 'bg-info'}">${portfolioHealth}</span>
    `;
    
    // Add portfolio insights section
    const insightsSection = document.createElement('div');
    insightsSection.className = 'dropdown-item';
    insightsSection.innerHTML = `
        <div class="row g-2 text-center">
            <div class="col-4">
                <div class="small text-muted">Stocks</div>
                <div class="fw-bold">${stockRowElements.length}</div>
            </div>
            <div class="col-4">
                <div class="small text-muted">Alerts</div>
                <div class="fw-bold">${totalAlerts}</div>
            </div>
            <div class="col-4">
                <div class="small text-muted">Status</div>
                <div class="fw-bold">${portfolioHealth}</div>
            </div>
        </div>
    `;
    
    document.getElementById('portfolioSummary').appendChild(insightsSection);

    // Stock row click handlers
    stockRowElements.forEach(row => {
        row.addEventListener('click', function() {
            const symbol = this.getAttribute('data-symbol');
            selectStock(symbol, this);
        });
    });

    // Chart period change handlers
    const periodButtons = document.querySelectorAll('input[name="chartPeriod"]');
    periodButtons.forEach(button => {
        button.addEventListener('change', function() {
            currentPeriod = this.value;
            if (selectedStock) {
                updateChart(selectedStock, currentPeriod);
            }
        });
    });

    // Clear stock filter button
    const clearStockFilterBtn = document.getElementById('clearStockFilter');
    if (clearStockFilterBtn) {
        clearStockFilterBtn.addEventListener('click', clearStockFilter);
    }

    // Performance monitoring
    const startTime = performance.now();
});

function selectStock(symbol, rowElement) {
    // Remove previous selection
    document.querySelectorAll('.stock-row').forEach(row => {
        row.classList.remove('selected');
    });
    
    // Add selection to clicked row
    rowElement.classList.add('selected');
    
    // Update chart title
    document.getElementById('chartTitle').textContent = `${symbol} Price Chart`;
    
    // Update news title and filter news by selected stock
    document.getElementById('newsTitle').textContent = 'Stock News';
    document.getElementById('selectedStockInfo').textContent = `(${symbol})`;
    document.getElementById('selectedStockInfo').style.display = 'inline';
    document.getElementById('clearStockFilter').style.display = 'inline-block';
    
    // Filter news by selected stock
    filterNewsByStock(symbol);
    
    // Update chart
    selectedStock = symbol;
    updateChart(symbol, currentPeriod);
    
    // Update news height after stock selection
    setTimeout(setPortfolioNewsHeight, 100);
}

function filterNewsByStock(symbol) {
    const newsCards = document.querySelectorAll('.news-card');
    let visibleCount = 0;
    
    newsCards.forEach(card => {
        const cardSymbol = card.dataset.symbol;
        if (cardSymbol === symbol) {
            card.style.display = 'block';
            card.classList.remove('hidden');
            visibleCount++;
        } else {
            card.style.display = 'none';
            card.classList.add('hidden');
        }
    });
    
    // Update filter info
    updateStockFilterInfo(symbol, visibleCount);
}

function updateStockFilterInfo(symbol, visibleCount) {
    let filterInfo = document.getElementById('filterInfo');
    if (!filterInfo) {
        filterInfo = document.createElement('div');
        filterInfo.id = 'filterInfo';
        filterInfo.className = 'filter-info';
        document.getElementById('portfolioNews').insertAdjacentElement('beforebegin', filterInfo);
    }
    
    filterInfo.textContent = `Showing ${visibleCount} news articles for ${symbol}`;
}

function clearStockFilter() {
    // Remove stock selection
    document.querySelectorAll('.stock-row').forEach(row => {
        row.classList.remove('selected');
    });
    
    // Reset news title
    document.getElementById('newsTitle').textContent = 'Portfolio News';
    document.getElementById('selectedStockInfo').style.display = 'none';
    document.getElementById('clearStockFilter').style.display = 'none';
    
    // Show all news
    const newsCards = document.querySelectorAll('.news-card');
    newsCards.forEach(card => {
        card.style.display = 'block';
        card.classList.remove('hidden');
    });
    
    // Reset chart
    document.getElementById('chartTitle').textContent = 'Select a stock to view chart';
    document.getElementById('chartPlaceholder').style.display = 'block';
    document.getElementById('portfolioChart').style.display = 'none';
    if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
    }
    
    // Update filter info
    updateStockFilterInfo('all stocks', newsCards.length);
    
    selectedStock = null;
}

function updateChart(symbol, period) {
    const chartContainer = document.querySelector('.chart-container');
    const chartLoading = document.getElementById('chartLoading');
    const chartPlaceholder = document.getElementById('chartPlaceholder');
    const canvas = document.getElementById('portfolioChart');
    
    // Show loading
    chartLoading.style.display = 'block';
    chartPlaceholder.style.display = 'none';
    canvas.style.display = 'none';
    
    // Calculate days based on period
    let days;
    switch(period) {
        case '1M': days = 30; break;
        case '3M': days = 90; break;
        case '6M': days = 180; break;
        case '1Y': days = 365; break;
        default: days = 30;
    }
    
    // Fetch chart data
    fetch(`/api/stock_history/${symbol}?days=${days}`)
        .then(response => response.json())
        .then(data => {
            chartLoading.style.display = 'none';
            canvas.style.display = 'block';
            
            if (data && data.length > 0) {
                createChart(data, symbol);
                // Update news height after chart is created
                setTimeout(setPortfolioNewsHeight, 100);
            } else {
                showChartError('No data available for this period');
            }
        })
        .catch(error => {
            console.error('Chart error:', error);
            chartLoading.style.display = 'none';
            showChartError('Failed to load chart data');
        });
}

function createChart(data, symbol) {
    const ctx = document.getElementById('portfolioChart').getContext('2d');
    
    // Destroy existing chart
    if (chartInstance) {
        chartInstance.destroy();
    }
    
    // Prepare data
    const labels = data.map(item => item.date);
    const prices = data.map(item => item.price);
    
    // Calculate color based on price trend
    const firstPrice = prices[0];
    const lastPrice = prices[prices.length - 1];
    const isPositive = lastPrice >= firstPrice;
    
    const gradient = ctx.createLinearGradient(0, 0, 0, 300);
    if (isPositive) {
        gradient.addColorStop(0, 'rgba(40, 167, 69, 0.2)');
        gradient.addColorStop(1, 'rgba(40, 167, 69, 0.05)');
    } else {
        gradient.addColorStop(0, 'rgba(220, 53, 69, 0.2)');
        gradient.addColorStop(1, 'rgba(220, 53, 69, 0.05)');
    }
    
    // Create new chart
    chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: `${symbol} Price`,
                data: prices,
                borderColor: isPositive ? '#28a745' : '#dc3545',
                backgroundColor: gradient,
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 6,
                pointHoverBackgroundColor: isPositive ? '#28a745' : '#dc3545',
                pointHoverBorderColor: '#fff',
                pointHoverBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: isPositive ? '#28a745' : '#dc3545',
                    borderWidth: 1,
                    cornerRadius: 8,
                    displayColors: false,
                    callbacks: {
                        title: function(context) {
                            return `${symbol} - ${context[0].label}`;
                        },
                        label: function(context) {
                            return `Price: $${context.parsed.y.toFixed(2)}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: '#6c757d',
                        maxTicksLimit: 8
                    }
                },
                y: {
                    display: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        color: '#6c757d',
                        callback: function(value) {
                            return '$' + value.toFixed(2);
                        }
                    }
                }
            },
            elements: {
                point: {
                    hoverRadius: 6
                }
            }
        }
    });
}

function showChartError(message) {
    const chartPlaceholder = document.getElementById('chartPlaceholder');
    chartPlaceholder.innerHTML = `
        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
        <p class="text-muted">${message}</p>
    `;
    chartPlaceholder.style.display = 'block';
}

// Add Stock Functions
function setStockSymbol(symbol) {
    document.getElementById('stockSymbol').value = symbol;
    document.getElementById('stockSymbol').focus();
}

function addStockToPortfolio() {
    const symbol = document.getElementById('stockSymbol').value.trim().toUpperCase();
    const quantity = document.getElementById('stockQuantity').value;
    
    if (!symbol) {
        showModalAlert('Please enter a stock symbol', 'danger');
        return;
    }
    
    // Show loading state
    const addButton = document.querySelector('#addStockModal .btn-success');
    const originalText = addButton.innerHTML;
    addButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Adding...';
    addButton.disabled = true;
    
    // Prepare form data
    const formData = new FormData();
    formData.append('symbol', symbol);
    formData.append('quantity', quantity);
    
    // Send request to add stock
    fetch('/add_stock', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (response.redirected) {
            // If redirected, it means success
            showModalAlert('Stock added successfully!', 'success');
            setTimeout(() => {
                window.location.href = response.url;
            }, 1500);
            return null;
        } else {
            return response.json();
        }
    })
    .then(data => {
        if (data) {
            if (data.success) {
                showModalAlert(data.success, 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else if (data.error) {
                showModalAlert(data.error, 'danger');
            }
        }
    })
    .catch(error => {
        console.error('Error adding stock:', error);
        showModalAlert('Failed to add stock. Please try again.', 'danger');
    })
    .finally(() => {
        // Reset button state
        addButton.innerHTML = originalText;
        addButton.disabled = false;
    });
}

function showModalAlert(message, type) {
    // Remove existing alerts
    const existingAlert = document.querySelector('#addStockModal .alert');
    if (existingAlert) {
        existingAlert.remove();
    }
    
    // Create new alert
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert alert at the top of modal body
    const modalBody = document.querySelector('#addStockModal .modal-body');
    modalBody.insertBefore(alertDiv, modalBody.firstChild);
    
    // Auto-dismiss success alerts after 3 seconds
    if (type === 'success') {
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 3000);
    }
}

// Clear form when modal is closed
document.addEventListener('DOMContentLoaded', function() {
    const addStockModal = document.getElementById('addStockModal');
    addStockModal.addEventListener('hidden.bs.modal', function() {
        document.getElementById('addStockForm').reset();
        // Remove any existing alerts
        const existingAlert = document.querySelector('#addStockModal .alert');
        if (existingAlert) {
            existingAlert.remove();
        }
    });
});

function refreshDashboard() {
    location.reload();
}

function testNotification() {
    console.log('Manual test notification triggered');
    
    const notificationIcon = document.getElementById('notificationIcon');
    const alertCountBadge = document.getElementById('alertCount');
    const alertList = document.getElementById('alertList');
    
    console.log('Test - DOM elements:', {
        notificationIcon: notificationIcon,
        alertCountBadge: alertCountBadge,
        alertList: alertList
    });
    
    if (notificationIcon && alertCountBadge && alertList) {
        // Force show notification
        notificationIcon.classList.remove('text-muted');
        notificationIcon.classList.add('text-warning', 'has-alerts');
        alertCountBadge.textContent = '5';
        alertCountBadge.style.display = 'block';
        
        alertList.innerHTML = `
            <div class="dropdown-item alert-item">
                <div class="d-flex align-items-start">
                    <div class="flex-shrink-0 me-2">
                        <i class="fas fa-exclamation-triangle text-warning"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong class="text-dark">TEST</strong>
                                <span class="badge bg-secondary ms-1">test</span>
                            </div>
                            <span class="badge bg-warning">medium</span>
                        </div>
                        <div class="text-dark small mt-1">Manual test alert - notification system working!</div>
                    </div>
                </div>
            </div>
        `;
        
        console.log('Test notification should now be visible');
        alert('Test notification triggered! Check the bell icon.');
    } else {
        console.error('Test failed - DOM elements not found');
        alert('Test failed - DOM elements not found. Check console.');
    }
}

// Portfolio News Sector Filter Functions
function initializePortfolioSectorFilter() {
    const sectorFilter = document.getElementById('newsSectorFilter');
    const newsCards = document.querySelectorAll('.news-card');
    const sectors = new Set();
    
    // Collect all unique sectors from news cards
    newsCards.forEach(card => {
        const sector = card.dataset.sector;
        if (sector && sector !== 'Unknown') {
            sectors.add(sector);
        }
    });
    
    // Populate dropdown with sectors
    sectors.forEach(sector => {
        const option = document.createElement('option');
        option.value = sector;
        option.textContent = sector;
        sectorFilter.appendChild(option);
    });
    
    // Add event listener for sector filter
    sectorFilter.addEventListener('change', filterPortfolioNewsBySector);
    
    // Add event listener for clear filter button
    const clearFilterBtn = document.getElementById('clearFilter');
    if (clearFilterBtn) {
        clearFilterBtn.addEventListener('click', clearPortfolioFilter);
    }
    
    // Initialize filter info
    setTimeout(() => {
        filterPortfolioNewsBySector();
    }, 100);
}

function filterPortfolioNewsBySector() {
    const selectedSector = document.getElementById('newsSectorFilter').value;
    const newsCards = document.querySelectorAll('.news-card');
    const clearFilterBtn = document.getElementById('clearFilter');
    let visibleCount = 0;
    
    newsCards.forEach(card => {
        const cardSector = card.dataset.sector;
        if (selectedSector === 'all' || cardSector === selectedSector) {
            card.style.display = 'block';
            card.classList.remove('hidden');
            visibleCount++;
        } else {
            card.style.display = 'none';
            card.classList.add('hidden');
        }
    });
    
    // Show/hide clear filter button
    if (selectedSector === 'all') {
        clearFilterBtn.style.display = 'none';
    } else {
        clearFilterBtn.style.display = 'inline-block';
    }
    
    // Update filter info
    updatePortfolioFilterInfo(selectedSector, visibleCount, newsCards.length);
}

function clearPortfolioFilter() {
    document.getElementById('newsSectorFilter').value = 'all';
    filterPortfolioNewsBySector();
}

function updatePortfolioFilterInfo(selectedSector, visibleCount, totalCount) {
    let filterInfo = document.getElementById('filterInfo');
    if (!filterInfo) {
        filterInfo = document.createElement('div');
        filterInfo.id = 'filterInfo';
        filterInfo.className = 'filter-info';
        document.getElementById('portfolioNews').insertAdjacentElement('beforebegin', filterInfo);
    }
    
    if (selectedSector === 'all') {
        filterInfo.textContent = `Showing all ${totalCount} news articles`;
    } else {
        filterInfo.textContent = `Showing ${visibleCount} of ${totalCount} articles for ${selectedSector}`;
    }
}

function setPortfolioNewsHeight() {
    const leftSide = document.querySelector('.col-12.col-lg-8');
    const newsCard = document.querySelector('.col-12.col-lg-4 .card');
    const newsContainer = document.getElementById('portfolioNews');
    
    if (leftSide && newsCard && newsContainer) {
        // Get the height of the left side content (portfolio holdings + chart)
        const leftHeight = leftSide.offsetHeight;
        
        // Set the news card height to match the left side
        newsCard.style.height = `${leftHeight}px`;
        
        // Calculate the available height for the news content
        const headerHeight = 120; // Approximate height of the filter header
        const availableHeight = leftHeight - headerHeight;
        
        // Set the news container max height
        newsContainer.style.maxHeight = `${availableHeight}px`;
    }
}

// Handle window resize
window.addEventListener('resize', function() {
    setTimeout(setPortfolioNewsHeight, 100);
});

// Handle chart updates that might change the height
function updateChartHeight() {
    setTimeout(setPortfolioNewsHeight, 200);
}
</script>

{% endblock %}
